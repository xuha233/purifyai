# PurifyAI × WinDirStat 融合方案 - 交接索引

> **交接目的**：将 PurifyAI 现有 AI 能力与 WinDirStat 深度磁盘扫描能力融合，实现智能全自动清理功能  
> **交接日期**：2026-02-21  
> **预计开发周期**：10-14天

---

## 📋 目录导航

### 1. 核心方案文档（按阅读顺序）

| 序号 | 文档 | 作用 | 阅读时间 | 必读 |
|------|------|------|---------|------|
| ① | [快速对接指南.md](快速对接指南.md) | 快速了解 PurifyAI 项目结构 | 5分钟 | ✅ |
| ② | [技术档案.md](技术档案.md) | 完整技术细节和 API 文档 | 30分钟 | ✅ |
| ③ | [PurifyAI智能清理融合方案.md](PurifyAI智能清理融合方案.md) | **核心设计方案**（含功能设计、架构、实现） | 60分钟 | ✅ |
| ④ | [目录结构.md](目录结构.md) | PurifyAI 完整目录结构参考 | 10分钟 | ⭕ |

---

## 🎯 方案核心要点（3分钟速览）

### 要做什么？

**一句话总结**：实现「选择磁盘 → 智能扫描 → AI分析 → 自动清理 → 生成报告」的全流程自动化。

**新增功能模块**：
1. **智能扫描选择器** - 混合模式（PurifyAI现有扫描器 + WinDirStat深度扫描）
2. **AI批量分析器** - 对扫描结果进行智能风险评估
3. **智能执行器** - 根据AI评估自动执行清理（高危需确认）
4. **清理报告生成器** - 生成详细的可视化报告

### 用户需求确认

| 需求 | 选择 | 实现方式 |
|------|:----:|----------|
| 自动清理支持 | 仅手动触发 | 用户手动选择位置执行 |
| 风险确认策略 | 高风险需确认 | safe/suspicious自动执行，dangerous需确认 |
| 扫描范围 | 混合模式 | 不同场景使用最优扫描策略 |
| 容错机制 | 智能重试 | 失败项自动重试3次后跳过 |

### 核心流程图

```
用户选择磁盘/目录
    ↓
智能扫描（混合模式）
    ├─ 系统垃圾 → SystemScanner
    ├─ 浏览器缓存 → BrowserScanner
    ├─ AppData → AppDataScanner
    └─ 自定义/磁盘 → DepthDiskScanner (WinDirStat)
    ↓
AI智能分析（批量评估）
    ├─ 评估每项风险（safe/suspicious/dangerous）
    ├─ 生成清理执行计划
    └─ 输出: CleanupPlan
    ↓
用户确认高危项（如有）
    ↓
智能执行清理
    ├─ Safe+Suspicious → 自动执行
    ├─ Dangerous → 用户确认后执行
    └─ 失败项 → 自动重试3次
    ↓
生成清理报告
    ├─ 统计摘要
    ├─ 失败项列表
    └─ 保存到数据库
```

---

## 🏗️ 技术架构概览

### 架构分层

```
┌─────────────────────────────────────────┐
│  UI层 (新增3个页面)                      │
│  SmartCleanPage | ConfirmDialog | Report │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  业务层 (新增5个核心模块)                │
│  SmartCleanWorkflow (工作流编排)         │
│  ├─ SmartScanSelector (扫描选择)         │
│  ├─ AIAnalyzer (AI分析)                  │
│  ├─ SmartExecutor (智能执行)              │
│  └─ CleanupReportGenerator (报告生成)   │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  基础层 (复用现有+新增)                  │
│  ConfigManager | Database | Logger      │
│  Cleaner (复用) | DepthDiskScanner(新)  │
└─────────────────────────────────────────┘
```

### WinDirStat 融合策略

| WinDirStat功能 | 融合方式 | 实现文件 | 价值 |
|---------------|---------|---------|------|
| NTFS MFT快速扫描 | 移植 | `core/depth_disk_scanner.py` | 大幅提升整盘扫描速度 |
| FinderNtfs/FinderBasic | 参考实现 | `core/depth_disk_scanner.py` | 跨文件系统支持 |
| Treemap可视化 | 新增组件 | `ui/treemap_widget.py` (可选) | 直观展示空间占用 |
| 硬链接处理 | 集成 | `core/depth_disk_scanner.py` | 避免重复计算 |

---

## 📁 新增文件清单

### 核心业务模块 (`src/core/`)

| 文件 | 功能 | 行数预估 | 优先级 |
|------|------|---------|-------|
| `smart_clean_workflow.py` | 智能清理工作流编排 | ~200 | P0 |
| `smart_scan_selector.py` | 智能扫描选择器 | ~150 | P0 |
| `ai_analyzer.py` | AI批量分析器 | ~200 | P0 |
| `smart_executor.py` | 智能执行器（容错重试） | ~250 | P0 |
| `cleanup_report_generator.py` | 报告生成器 | ~150 | P1 |
| `depth_disk_scanner.py` | 深度磁盘扫描器（WinDirStat融合） | ~300 | P0 |
| `models_smart.py` | 智能清理数据模型 | ~150 | P0 |
| `backup_manager.py` | 备份管理器 | ~100 | P1 |

**新增模块总计**: ~1,500行

### UI模块 (`src/ui/`)

| 文件 | 功能 | 行数预估 | 优先级 |
|------|------|:-------:|-------|
| `smart_cleaner.py` | 智能清理主页面 | ~400 | P0 |
| `high_risk_dialog.py` | 高危项确认对话框 | ~200 | P0 |
| `cleanup_report_page.py` | 清理报告页面 | ~500 | P0 |

**新增UI总计**: ~1,100行

### 数据库扩展

**新增表**:
- `cleanup_plans` - 清理计划记录
- `cleanup_items` - 清理项明细
- `cleanup_executions` - 执行结果记录

---

## 🔌 接口对接要点

### 与现有模块的对接

#### 1. 扫描器对接

**现状**: `src/core/scanner.py` 中已有 `SystemScanner`, `BrowserScanner`, `AppDataScanner`

**对接方式**:
```python
# 新增 smart_scan_selector.py

class SmartScanSelector:
    def select_scanner(self, scan_type: str) -> QObjectScanner:
        """根据扫描类型选择扫描器"""
        scanners = {
            'system': SystemScanner(),
            'browser': BrowserScanner(),
            'appdata': AppDataScanner(),
            'custom': DepthDiskScanner(),  # 新增
            'disk': DepthDiskScanner()      # 新增
        }
        return scanners.get(scan_type)
```

#### 2. AI模块对接

**现状**: 已有 `ai_client.py`, `ai_enhancer.py`, `ai_response_parser.py`

**对接方式**:
```python
# 新增 ai_analyzer.py

class AIAnalyzer:
    def __init__(self):
        # 复用现有的 AI 客户端
        self.ai_client = get_ai_enhancer()
        
    def analyze_scan_results(self, items: List[ScanItem]) -> CleanupPlan:
        """批量调用AI进行风险评估"""
        # 使用现有的 ai_client.chat() 方法
        # 使用现有的 ResponseParser 进行解析
        pass
```

#### 3. 清理器对接

**现状**: `src/core/cleaner.py` 已有 `Cleaner` 类

**对接方式**:
```python
# 新增 smart_executor.py

class SmartExecutor:
    def __init__(self):
        # 复用现有的 Cleaner
        self.cleaner = Cleaner()
        
    def execute_item(self, item: CleanupItem) -> bool:
        """执行单个清理项（带重试）"""
        for attempt in range(3):
            try:
                self.cleaner.clean([item], clean_type='auto')
                return True
            except Exception:
                continue
        return False
```

#### 4. 配置管理对接

**现状**: `src/core/config_manager.py` 已有 `ConfigManager`

**新增配置项**:
```json
{
  "smart_clean": {
    "enabled": true,
    "default_scan_type": "system",
    "confirm_dangerous": true,
    "auto_confirm_suspicious": true,
    "max_retries": 3,
    "retry_delay": 2,
    "use_mft": true,
    "backup_enabled": true
  }
}
```

---

## 🚀 开发实施计划

### Phase分配

| Phase | 内容 | 预计时间 | 交付物 |
|-------|------|---------|-------|
| P1: 基础架构 | 数据模型、扫描选择器、UI框架 | 1-2天 | 可运行的基础框架 |
| P2: 扫描功能 | 深度磁盘扫描器、混合扫描策略 | 2-3天 | 完整扫描能力 |
| P3: AI分析 | AI批量分析器、提示词增强 | 2-3天 | AI评估+计划生成 |
| P4: 执行器 | 智能执行器、容错重试 | 2-3天 | 自动清理执行 |
| P5: 报告 | 报告生成器、报告页面 | 1-2天 | 可视化报告 |
|**P6: 集成**| 端到端测试、性能优化 | 1-2天 | 可发布版本 |

**总预估**: 10-14天

### 并行开发建议

**A组（核心业务）**:
- P2: 扫描功能
- P3: AI分析

**B组（UI+执行）**:
- P1: 基础架构（UI框架）
- P4: 执行器

**C组（报告）**:
- P5: 报告生成

**最后合并**:
- P6: 集成测试

---

## ⚠️ 关键技术风险

| 风险 | 影响 | 缓解措施 |
|------|:----:|---------|
| AI API调用失败 | 无法生成清理计划 | 优雅降级到规则引擎 |
| NTFS MFT读取失败 | 扫描速度变慢 | 降级到基础API扫描 |
| 权限不足 | 清理失败 | 提示提升权限，支持重试 |
| 内存占用过高 | 大型磁盘扫描卡顿 | 分批处理，限制同时加载项数 |
| 文件占用 | 删除失败 | 提示关闭应用，支持跳过 |

---

## 📊 验收标准

### 功能验收

- [ ] 用户可选择磁盘/目录进行智能清理
- [ ] 扫描进度实时显示，可取消
- [ ] AI能正确评估文件风险（safe/suspicious/dangerous）
- [ ] safe+suspicious自动执行，dangerous弹出确认
- [ ] 失败项自动重试3次
- [ ] 生成详细的清理报告
- [ ] 报告可导出
- [ ] 失败项可手动重试

### 性能验收

| 指标 | 目标值 | 测试方法 |
|------|-------|---------|
| 100GB磁盘扫描 | < 30秒 | 使用NTFS MFT |
| 10万项AI分析 | < 5分钟 | 批量调用 |
| 清理执行速度 | > 100项/秒 | 统计平均速度 |
| 内存占用 | < 500MB | 监控峰值 |

### 代码质量

- [ ] 单元测试覆盖率 > 80%
- [ ] 无内存泄漏
- [ ] 符合 PEP 8 规范
- [ ] 完整的错误处理
- [ ] 详细的日志记录

---

## 📞 审核反馈

### 审核报告

📄 **[审核反馈报告.md](审核反馈报告.md)** - **最新审核意见**

包含：
- ✅ 整体评价
- ⚠️ 7个必须修复的关键问题
- 💡 5个建议采纳的优化
- 📊 时间调整（13天MVP）

### 技术决策（已确认）

基于开发团队评审，已确认以下技术方案：

#### 1. NTFS MFT实现方式 ⭐方案A

**推荐选择**: ctypes + Windows API（方案A）

| 方案 | 决策 | 理由 |
|------|------|------|
| A: ctypes + Windows API | **✅ 采用** | 无外部依赖、性能最优、与现有 ctypes 使用一致 |
| B: pywin32 | ❌ 未采用 | 增加用户安装复杂度 |
| C: 读取设备文件 | ❌ 未采用 | 代码复杂、易出错、平台限制 |

**实施策略**: MVP 阶段使用基础 API 扫描，NTFS MFT 整合到 V2 版本

---

#### 2. AI批处理策略 ⭐动态渐进

**采用方案**: 动态批次大小 + 渐进降级

```
初始批次: 50项
├─ AI 成功 → 尝试增加到 100项/批（响应快）
├─ AI 失败 → 减少到 30项/批（响应慢）
└─ 重试3次后 → 切换规则引擎继续

降级策略:
  AI正常 → AI评估
  AI失败(1次) → 减小批次重试
  AI失败(3次) → 规则引擎评估
```

---

#### 3. 备份机制 ⭐增量备份

**采用方案**: 混合备份策略

| 项目类型 | 备份方式 | 空间占用 |
|---------|---------|---------|
| Safe项 | 不备份（可直接删除） | 0% |
| Suspicious项 | 硬链接引用（几乎不占空间） | ~1% |
| Dangerous项 | 完整备份到自定义目录 | 按实际大小 |

**保留策略**:
- 7天每日清理历史 + 关键操作记录
- 使用 SQLite 存储备份路径
- 提供 "恢复" 功能而非完整版本回退

---

#### 4. UI开发优先级 ⭐简化设计

**采用方案**: 聚焦核心功能，延后可视化

| 功能 | MVP | V2 |
|------|-----|----|
| SmartCleanPage | ✅ | - |
| HighRiskConfirmDialog | ✅ | - |
| CleanupReportPage（基础） | ✅ | - |
| CleanupReportPage（图表） | - | ✅ |
| Treemap可视化 | - | ✅ |

**理由**: Treemap 开发复杂度高，对核心功能贡献有限，可先验证 MVP 成功后再添加

---

### MVP 实施计划

详见: `[01_MVP实施计划.md](01_MVP实施计划.md)`

**MVP 范围**:
- ✅ 基础API深度扫描
- ✅ AI批量分析（带规则引擎降级）
- ✅ 智能执行（带重试，无备份）
- ✅ 高危确认对话框
- ✅ 简化版报告（统计+列表）
- ❌ NTFS MFT（V2）
- ❌ 完整备份（V2）
- ❌ Treemap可视化（V2）

**预计开发时间**: 11天

### 反馈通道

**技术疑问** → 查看 [技术档案.md](技术档案.md) 第7章 API接口  
**实现细节** → 查看 [PurifyAI智能清理融合方案.md](PurifyAI智能清理融合方案.md) 第8章  
**代码参考** → 目录 `src/` (现有实现) 和 `windirstat/` (WinDirStat源码)

---

## 📚 附录：快速参考

### 关键文件路径速查

```
PurifyAI项目
├── src/
│   ├── core/
│   │   ├── scanner.py              # 现有扫描器
│   │   ├── cleaner.py              # 现有清理器
│   │   ├── ai_client.py            # AI客户端
│   │   ├── ai_enhancer.py          # AI增强器
│   │   ├── ai_response_parser.py   # AI响应解析
│   │   ├── config_manager.py       # 配置管理
│   │   └── database.py             # 数据库
│   │
│   └── ui/
│       ├── dashboard.py            # 仪表板
│       └── settings.py             # 设置页面

WinDirStat项目
├── windirstat/
│   ├── DirStatDoc.h/cpp            # 文档类（扫描引擎）
│   ├── Finder.h/cpp                # 文件查找接口
│   ├── FinderBasic.h/cpp           # 基础API实现
│   ├── FinderNtfs.h/cpp            # NTFS MFT实现
│   ├── Item.h/cpp                  # 扫描项数据模型
│   └── Controls/TreeMap.h/cpp      # Treemap可视化
```

### 数据流关键类

```
扫描阶段
  ScanItem → (继承) CTreeListItem → (映射) CleanupItem

AI分析阶段
  ScanItem → AIAnalyzer → CleanupPlan

执行阶段
  CleanupPlan → SmartExecutor → ExecutionResult

报告阶段
  ExecutionResult → CleanupReportGenerator → 可视化报告
```

### 配置键值对照

| 现有配置 | 新增配置 | 说明 |
|---------|---------|------|
| `ai/enabled` | `smart_clean/enabled` | AI评估开关 |
| - | `smart_clean/confirm_dangerous` | 高危确认开关 |
| - | `smart_clean/max_retries` | 重试次数 |
| - | `smart_clean/use_mft` | 使用MFT扫描 |

---

## ✅ 交接确认

**交接方**: AI规划团队  
**接收方**: 开发团队  
**交接内容**:
- [x] 功能需求确认
- [x] 技术方案设计
- [x] 数据模型定义
- [x] 接口对接说明
- [x] 开发计划拆分
- [x] 验收标准定义

---

**下一步行动**:
1. 开发团队审阅方案
2. 技术研讨会讨论技术风险
3. 确认实现细节和优先级
4. 开始 Phase 1 开发

**文档版本**: v1.0  
**最后更新**: 2026-02-21