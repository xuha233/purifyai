# PurifyAI èåˆæ–¹æ¡ˆå®¡æ ¸åé¦ˆæŠ¥å‘Š

> **å®¡æ ¸æ—¥æœŸ**: 2026-02-21
> **å®¡æ ¸çŠ¶æ€**: æœ‰æ¡ä»¶é€šè¿‡ï¼ˆéœ€ä¿®å¤å…³é”®é—®é¢˜ï¼‰
> **ç‰ˆæœ¬**: v1.1

---

## âœ… æ•´ä½“è¯„ä»·

**æ–¹æ¡ˆæˆç†Ÿåº¦**: è‰¯å¥½
**è¯„åˆ†**: 82/100

**ä¼˜ç‚¹**:
- æ¶æ„è®¾è®¡æ¸…æ™°ï¼Œæ¨¡å—åˆ’åˆ†åˆç†
- åŠŸèƒ½è®¾è®¡å®Œæ•´ï¼Œè¦†ç›–æ ¸å¿ƒéœ€æ±‚
- MVPä¼˜å…ˆçº§åˆ’åˆ†æ°å½“
- è§„åˆ™å¼•æ“é™çº§ä¿è¯é²æ£’æ€§

**éœ€æ”¹è¿›**:
- æ•°æ®åº“è®¾è®¡éœ€ä¼˜åŒ–ï¼ˆå¤§å­—æ®µå¤„ç†ï¼‰
- å†…å­˜å ç”¨é¢„ä¼°åä½ï¼Œéœ€ä¼˜åŒ–
- AIæˆæœ¬æœªè€ƒè™‘ï¼Œéœ€è¦æˆæœ¬æ§åˆ¶æ–¹æ¡ˆ
- å…³é”®æ¨¡å—è®¾è®¡ä¸å¤Ÿè¯¦ç»†

---

## âš ï¸ å¿…é¡»ä¿®å¤çš„7ä¸ªå…³é”®é—®é¢˜

### é—®é¢˜1: æ•°æ®åº“è®¾è®¡å†—ä½™

**é—®é¢˜ç°çŠ¶**: 10ä¸‡æ¸…ç†é¡¹å ç”¨>100MBï¼Œai_reasonç­‰æ–‡æœ¬å­—æ®µé€ æˆå†—ä½™

**å½±å“**: æ•°æ®åº“è†¨èƒ€ï¼Œæ€§èƒ½ä¸‹é™ï¼Œå¤‡ä»½æˆæœ¬é«˜

**è§£å†³æ–¹æ¡ˆ** - åˆ†ç¦»å¤§å­—æ®µï¼ˆæ–¹æ¡ˆAï¼‰:
```sql
-- ä¸»è¡¨ï¼ˆç²¾ç®€ï¼‰
CREATE TABLE cleanup_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    plan_id TEXT NOT NULL,
    path TEXT NOT NULL,
    size INTEGER NOT NULL,
    item_type TEXT NOT NULL,
    original_risk TEXT NOT NULL,
    ai_risk TEXT NOT NULL,
    reason_id INTEGER,           -- å…³è”ç´¢å¼•ï¼Œè€Œéç›´æ¥å­˜å‚¨æ–‡æœ¬
    status TEXT NOT NULL,
    FOREIGN KEY (plan_id) REFERENCES cleanup_plans(plan_id),
    FOREIGN KEY (reason_id) REFERENCES cleanup_reasons(id)
);

-- åŸå› è¡¨ï¼ˆå…±äº«ï¼‰
CREATE TABLE cleanup_reasons (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    reason TEXT NOT NULL,         -- å®Œæ•´åŸå› 
    hash TEXT UNIQUE               -- åŸå› çš„MD5å“ˆå¸Œï¼Œç”¨äºå»é‡
);

-- æ€§èƒ½å¯¹æ¯”
-- åŸæ–¹æ¡ˆ: 10ä¸‡é¡¹ Ã— 100å­—èŠ‚/é¡¹ = 10MB (ä»…ai_reasonå­—æ®µ)
-- æ–°æ–¹æ¡ˆ: 100ä¸ªå”¯ä¸€åŸå›  Ã— 100å­—èŠ‚ = 10KB
```

---

### é—®é¢˜2: å†…å­˜å ç”¨ä¼°ç®—ä¸è¶³

**é—®é¢˜ç°çŠ¶**:
- é¢„ä¼°300MBï¼Œå®é™…ä¸Š10ä¸‡é¡¹æ¥è¿‘500MB
- CleanupItemä¿å­˜å®Œæ•´ä¿¡æ¯å¯¼è‡´å†…å­˜æº¢å‡º

**è§£å†³æ–¹æ¡ˆ** - IDç´¢å¼•æ–¹æ¡ˆ:
```python
@dataclass
class CleanupItem:
    """è½»é‡çº§æ¸…ç†é¡¹"""
    item_id: int                     # å”¯ä¸€ID
    path: str                       # è·¯å¾„ï¼ˆä¸ä¿å­˜å…¶ä»–ä¿¡æ¯ï¼‰
    size: int

# è¯¦ç»†ä¿¡æ¯å­˜å‚¨åœ¨å­—å…¸ä¸­ï¼ŒæŒ‰éœ€åŠ è½½
_item_details: Dict[int, ItemDetail] = {}

class ItemDetail:
    """é¡¹ç›®è¯¦ç»†ä¿¡æ¯ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰"""
    ai_risk: str
    ai_reason: str
    confidence: float
    error_message: str

# å†…å­˜ä¼˜åŒ–æ•ˆæœ
# åŸæ–¹æ¡ˆ: 10ä¸‡é¡¹ Ã— 500å­—èŠ‚ = 50MB
# æ–°æ–¹æ¡ˆ: 10ä¸‡é¡¹ Ã— 100å­—èŠ‚ = 10MB + ç»†èŠ‚ç¼“å­˜ 10MB = 20MB
# é™ä½: 60%
```

---

### é—®é¢˜3: AI APIæˆæœ¬æœªè€ƒè™‘

**é—®é¢˜ç°çŠ¶**:
- æ‰¹é‡è°ƒç”¨AIï¼ˆ50é¡¹/æ‰¹ï¼‰ä¼šå¯¼è‡´é«˜æˆæœ¬
- 10ä¸‡é¡¹éœ€è¦2000æ¬¡è°ƒç”¨ï¼Œæˆæœ¬ä¸å¯æ§

**è§£å†³æ–¹æ¡ˆ** - ä¼˜å…ˆè§„åˆ™å¼•æ“ï¼Œé™çº§AI:
```python
class AIAnalyzer:
    """AIåˆ†æå™¨ - æˆæœ¬æ§åˆ¶ç‰ˆæœ¬"""

    def analyze_scan_results(self, items: List[ScanItem]) -> CleanupPlan:
        """
        åˆ†æç­–ç•¥:
        1. å…ˆç”¨è§„åˆ™å¼•æ“è¯„ä¼°ï¼ˆå…è´¹ã€å¿«é€Ÿï¼‰
        2. ä»…å¯¹suspiciousé¡¹è°ƒç”¨AIç¡®è®¤
        3. safeé¡¹ç›´æ¥è·³è¿‡AI

        æˆæœ¬å¯¹æ¯”:
        - å…¨AI: 10ä¸‡é¡¹/50 = 2000æ¬¡è°ƒç”¨
        - æ··åˆ: å‡è®¾20%å¯ç–‘ = 2ä¸‡é¡¹ â†’ 400æ¬¡è°ƒç”¨
        - èŠ‚çœ: 80%
        """
        # æ­¥éª¤1: è§„åˆ™å¼•æ“è¯„ä¼°æ‰€æœ‰é¡¹
        self._rule_engine_assess(items)

        # æ­¥éª¤2: ä»…å¯¹suspiciousé¡¹è°ƒç”¨AI
        suspicious_items = [i for i in items if i.risk == RiskLevel.SUSPICIOUS]
        if len(suspicious_items) > 0:
            self._ai_assess(suspicious_items)
```

---

### é—®é¢˜4: å¤‡ä»½ç®¡ç†å™¨æœªè¯¦ç»†è®¾è®¡

**é—®é¢˜ç°çŠ¶**: BackupManagerä»…æœ‰æ¦‚å¿µï¼Œæ— å…·ä½“è®¾è®¡

**è§£å†³æ–¹æ¡ˆ** - å®Œæ•´BackupManagerè®¾è®¡:
```python
class BackupManager(QObject):
    """å¤‡ä»½ç®¡ç†å™¨ - MVPå®Œæ•´è®¾è®¡"""

    def __init__(self):
        self.backup_root = os.path.expanduser('~/AppData/Local/PurifyAI/Backups')
        self.backup_db = os.path.join(self.backup_root, 'backups.db')
        os.makedirs(self.backup_root, exist_ok=True)
        self._init_database()

    def create_backup(self, item: CleanupItem) -> Optional[str]:
        """åˆ›å»ºå¤‡ä»½ï¼ˆæ ¹æ®é£é™©ç­‰çº§é€‰æ‹©ç­–ç•¥ï¼‰"""
        if item.ai_risk == RiskLevel.SAFE:
            # Safeé¡¹ä¸å¤‡ä»½
            return None
        elif item.ai_risk == RiskLevel.SUSPICIOUS:
            # Suspiciousé¡¹åˆ›å»ºç¡¬é“¾æ¥
            return self._create_hardlink(item)
        else:
            # Dangerousé¡¹å®Œæ•´å¤‡ä»½
            return self._create_full_backup(item)

    def restore_backup(self, item: CleanupItem) -> bool:
        """æ¢å¤å¤‡ä»½"""
        backup_info = self._get_backup_info(item.item_id)
        if not backup_info:
            return False

        if backup_info['type'] == 'full':
            return self._restore_full_backup(item, backup_info['path'])
        else:
            return self._remove_hardlink(item)

    def cleanup_old_backups(self, days: int = 7):
        """æ¸…ç†æ—§å¤‡ä»½"""
        cutoff = datetime.now() - timedelta(days=days)
        self.db.execute("DELETE FROM backups WHERE created_at < ?", (cutoff.isoformat(),))
```

---

### é—®é¢˜5: UIçº¿ç¨‹é˜»å¡é£é™©

**é—®é¢˜ç°çŠ¶**: æ‰«æã€AIåˆ†æã€æ¸…ç†åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œä¼šå¯¼è‡´UIå¡é¡¿

**è§£å†³æ–¹æ¡ˆ** - å¤šçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œ:
```python
class SmartCleanWorkflow(QObject):
    """æ™ºèƒ½æ¸…ç†å·¥ä½œæµ - å¼‚æ­¥ç‰ˆæœ¬"""

    # å…¨éƒ¨ä½¿ç”¨å·¥ä½œçº¿ç¨‹
    def execute_async(self):
        # åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ‰§è¡Œå®Œæ•´æµç¨‹
        worker = WorkflowWorker(self)
        worker.progress.connect(self.update_progress)
        worker.complete.connect(self.on_complete)
        worker.error.connect(self.on_error)

        # ä½¿ç”¨QThreadPoolæ‰§è¡Œï¼Œä¸é˜»å¡UI
        QThreadPool.globalInstance().start(worker)

class WorkflowWorker(QRunnable):
    """å·¥ä½œæµWorker"""

    def run(self):
        # æ‰§è¡Œæ‰«æã€AIã€æ¸…ç†
        # æ‰€æœ‰è€—æ—¶æ“ä½œåœ¨æ­¤çº¿ç¨‹
        pass
```

---

### é—®é¢˜6: é”™è¯¯æ¢å¤æœºåˆ¶ä¸å®Œæ•´

**é—®é¢˜ç°çŠ¶**: æ‰§è¡Œå¤±è´¥åæ— æ³•å›æ»šï¼Œç”¨æˆ·æ•°æ®æœ‰é£é™©

**è§£å†³æ–¹æ¡ˆ** - RecoveryManagerè®¾è®¡:
```python
class RecoveryManager(QObject):
    """æ¢å¤ç®¡ç†å™¨"""

    def __init__(self):
        self.recovery_log: List[RecoveryRecord] = []

    def record_deletion(self, item: CleanupItem, backup_path: str):
        """è®°å½•åˆ é™¤æ“ä½œ"""
        record = RecoveryRecord(
            item_id=item.item_id,
            original_path=item.path,
            backup_path=backup_path,
            timestamp=datetime.now()
        )
        self.recovery_log.append(record)

    def rollback_all(self) -> bool:
        """å›æ»šæ‰€æœ‰æ“ä½œ"""
        # æŒ‰è®°å½•é€†åºæ¢å¤
        failed = []
        for record in reversed(self.recovery_log):
            if not self._restore_record(record):
                failed.append(record)

        self.recovery_log.clear()
        return len(failed) == 0

    def recover_item(self, plan_id: str, item_id: int) -> bool:
        """æ¢å¤å•ä¸ªé¡¹ç›®"""
        record = self._get_record(plan_id, item_id)
        if record:
            return self._restore_record(record)
        return False
```

---

### é—®é¢˜7: æ€§èƒ½æŒ‡æ ‡ä¸åˆç†

**é—®é¢˜ç°çŠ¶**:
- 100GBæ‰«æ<30ç§’ï¼ˆMFTæœªå®ç°æ—¶ä¸å¯èƒ½ï¼‰
- 10ä¸‡é¡¹AI<5åˆ†é’Ÿï¼ˆæœªè€ƒè™‘ç½‘ç»œå’ŒAPIé™æµï¼‰

**è§£å†³æ–¹æ¡ˆ** - ä¿®æ­£ä¸ºåˆç†åŸºå‡†:
| æŒ‡æ ‡ | é¢„è®¾å€¼ | ä¿®æ­£å | è¯´æ˜ |
|------|-------|-------|------|
| 100GBæ‰«æ | <30ç§’ | <3åˆ†é’Ÿ (åŸºç¡€API) | MVPåŸºç¡€APIï¼ŒV2 MFTå¯è¾¾30ç§’ |
| 10ä¸‡é¡¹åˆ†æ | <5åˆ†é’Ÿ | ~5-10åˆ†é’Ÿ | è€ƒè™‘ç½‘ç»œå»¶è¿Ÿå’Œé™æµ |
| æ¸…ç†æ‰§è¡Œ | >100é¡¹/ç§’ | >50é¡¹/ç§’ | è€ƒè™‘é‡è¯•æœºåˆ¶ |
| å†…å­˜å ç”¨ | <500MB | <300MB | ä¼˜åŒ–åç›®æ ‡ |

---

## ğŸ’¡ å»ºè®®é‡‡çº³çš„5ä¸ªä¼˜åŒ–

### ä¼˜åŒ–1: æ·»åŠ è¿›åº¦é¢„ä¼°

```python
class ProgressEstimator:
    """è¿›åº¦é¢„ä¼°å™¨"""

    def estimate_remaining(self, progress: ProgressInfo) -> str:
        """é¢„ä¼°å‰©ä½™æ—¶é—´"""
        elapsed = time.time() - self.start_time
        progress_pct = progress.current / progress.total
        estimated_total = elapsed / progress_pct if progress_pct > 0 else 0
        remaining = estimated_total - elapsed

        if remaining < 60:
            return f"å‰©ä½™ {int(remaining)}ç§’"
        else:
            return f"å‰©ä½™ {int(remaining//60)}åˆ†{int(remaining%60)}ç§’"
```

---

### ä¼˜åŒ–2: å¢åŠ æ‰«æé¢„æ£€æŸ¥

```python
class ScanPreChecker:
    """æ‰«æé¢„æ£€æŸ¥å™¨"""

    def check_path(self, path: str) -> CheckResult:
        """é¢„æ£€æŸ¥ç›®æ ‡è·¯å¾„"""
        issues = []

        # æ£€æŸ¥1: æƒé™
        if not os.access(path, os.R_OK):
            issues.append("æ— è¯»å–æƒé™")

        # æ£€æŸ¥2: é©±åŠ¨å™¨è¿æ¥
        if not os.path.exists(path):
            issues.append("è·¯å¾„ä¸å­˜åœ¨")

        # æ£€æŸ¥3: ç£ç›˜ç©ºé—´
        stat = os.statvfs(path) if sys.platform != 'win32' else None
        if stat and stat.f_bavail * stat.f_frsize < 100 * 1024 * 1024:
            issues.append("ç£ç›˜ç©ºé—´ä¸è¶³")

        return CheckResult(issues=issues, can_scan=len(issues) == 0)
```

---

### ä¼˜åŒ–3: æ”¯æŒæ‰«ææš‚åœ/æ¢å¤

```python
class PausableScanner(QObject):
    """å¯æš‚åœæ‰«æå™¨"""

    def pause(self):
        self._paused = True

    def resume(self):
        self._paused = False
        self._continue_scan()

    def cancel(self):
        self._cancelled = True

    def _continue_scan(self):
        # ä»ä¸Šæ¬¡åœæ­¢çš„ä½ç½®ç»§ç»­
        while not self._cancelled and not self._paused:
            # æ‰«æé€»è¾‘
            pass
```

---

### ä¼˜åŒ–4: æ‰«æç»“æœå¯¼å‡º

```python
class ScanResultExporter:
    """æ‰«æç»“æœå¯¼å‡ºå™¨"""

    def export_to_csv(self, plan: CleanupPlan, filepath: str):
        """å¯¼å‡ºåˆ°CSV"""
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write('Path,Size,Risk,Reason\n')
            for item in plan.all_items:
                f.write(f'{item.path},{item.size},{item.ai_risk},{item.ai_reason}\n')

    def export_to_json(self, plan: CleanupPlan, filepath: str):
        """å¯¼å‡ºåˆ°JSON"""
        data = {
            'plan_id': plan.plan_id,
            'scan_type': plan.scan_type,
            'items': [asdict(item) for item in plan.all_items]
        }
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
```

---

### ä¼˜åŒ–5: æ·»åŠ å•å…ƒæµ‹è¯•æ¡†æ¶

```python
# tests/test_smart_scanner.py
import pytest

class TestSmartScanSelector:
    """æ‰«æé€‰æ‹©å™¨æµ‹è¯•"""

    def test_select_system_scanner(self):
        selector = SmartScanSelector()
        scanner = selector.select_scanner('system', '')
        assert isinstance(scanner, SystemScanner)

    def test_select_custom_scanner(self):
        selector = SmartScanSelector()
        scanner = selector.select_scanner('custom', '/test/path')
        assert isinstance(scanner, DepthDiskScanner)

# tests/test_ai_analyzer.py
class TestAIAnalyzer:
    """AIåˆ†æå™¨æµ‹è¯•"""

    @patch('ai_analyzer.AIAnalyzer._ai_assess')
    def test_analyze_scan_results(self, mock_ai):
        analyzer = AIAnalyzer()
        mock_ai.return_value = []
        # æµ‹è¯•è§„åˆ™å¼•æ“é™çº§
        pass
```

---

## ğŸ“Š æ—¶é—´è°ƒæ•´

### å¼€å‘æ—¶é—´é¢„ä¼°æ›´æ–°

| é˜¶æ®µ | åŸé¢„ä¼° | ä¿®æ­£å | å¢åŠ  | åŸå›  |
|------|-------|-------|------|------|
| Phase 0-1 | 2.5å¤© | 3å¤© | +0.5å¤© | æ•°æ®åº“ä¼˜åŒ– |
| Phase 2 | 2å¤© | 2.5å¤© | +0.5å¤© | AIæˆæœ¬æ§åˆ¶ |
| Phase 3 | 2.5å¤© | 3å¤© | +0.5å¤© | å¼‚æ­¥æ‰§è¡Œ |
| Phase 4 | 2å¤© | 2.5å¤© | +0.5å¤© | æ€§èƒ½ä¼˜åŒ– |
| Phase 5 | 2å¤© | 2å¤© | 0å¤© | - |
| **MVPæ€»è®¡** | **11å¤©** | **13å¤©** | **+2å¤©** | ä¿®å¤é—®é¢˜ |

### V2 æ—¶é—´é¢„ä¼°

| åŠŸèƒ½ | é¢„ä¼°æ—¶é—´ | è¯´æ˜ |
|------|---------|------|
| NTFS MFTæ‰«æ | 3-5å¤© | æ ¸å¿ƒåŠŸèƒ½ |
| å®Œæ•´å¤‡ä»½æœºåˆ¶ | 2-3å¤© | å®Œå–„å¤‡ä»½ |
| Treemapå¯è§†åŒ– | 3-4å¤© | å¯è§†åŒ– |
| é«˜çº§æŠ¥å‘Šå›¾è¡¨ | 2å¤© | å›¾è¡¨ç»„ä»¶ |
| æ€§èƒ½ä¼˜åŒ– | ongoing | æŒç»­ä¼˜åŒ– |
| **V2æ€»è®¡** | **10-14å¤©** | æ ¸å¿ƒåŠŸèƒ½ |

### MVP + V2 æ€»è®¡

| ç‰ˆæœ¬ | åŸé¢„ä¼° | ä¿®æ­£å |
|------|-------|-------|
| MVP | 11å¤© | 13å¤© |
| V2 | 10-14å¤© | 10-14å¤© |
| **æ€»è®¡** | **21-25å¤©** | **23-27å¤©** |

---

## ğŸ“‹ ä¿®å¤ä¼˜å…ˆçº§

| é—®é¢˜ | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ |
|------|:------:|---------|
| é—®é¢˜1: æ•°æ®åº“å†—ä½™ | P0 - å¿…ä¿® | 0.5å¤© |
| é—®é¢˜2: å†…å­˜å ç”¨ | P0 - å¿…ä¿® | 0.5å¤© |
| é—®é¢˜3: AIæˆæœ¬æ§åˆ¶ | P0 - å¿…ä¿® | 0.5å¤© |
| é—®é¢˜6: é”™è¯¯æ¢å¤ | P0 - å¿…ä¿® | 1å¤© |
| é—®é¢˜4: å¤‡ä»½ç®¡ç† | P1 - é‡è¦ | 0.5å¤© |
| é—®é¢˜5: UIçº¿ç¨‹ | P1 - é‡è¦ | 0.5å¤© |
| é—®é¢˜7: æ€§èƒ½æŒ‡æ ‡ | P2 - ä¼˜åŒ– | 0.5å¤© |

**é¢å¤–æ—¶é—´**: +4å¤©ï¼ˆè®¡å…¥MVPæ—¶é—´è°ƒæ•´ä¸­ï¼‰

---

## âœ…å®¡æ ¸æ¡ä»¶

**å®¡æ ¸é€šè¿‡æ¡ä»¶**:
1. 7ä¸ªå…³é”®é—®é¢˜å…¨éƒ¨ä¿®å¤
2. 5ä¸ªä¼˜åŒ–å»ºè®®è‡³å°‘é‡‡çº³3ä¸ª
3. éªŒæ”¶æ ‡å‡†æ›´æ–°ä¸ºåˆç†å€¼

**å½“å‰çŠ¶æ€**: âš ï¸ æœ‰æ¡ä»¶é€šè¿‡ï¼ˆéœ€ä¿®å¤åé‡æ–°å®¡æ ¸ï¼‰

---

## ğŸ“ è”ç³»ä¸åé¦ˆ

**å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦è¿›ä¸€æ­¥è¯´æ˜**:
- æŠ€æœ¯ç»†èŠ‚ â†’ æŸ¥çœ‹ç›¸åº”æ¨¡å—çš„è¯¦ç»†è®¾è®¡æ–‡æ¡£
- å®æ–½å»ºè®® â†’ å‚è€ƒ `01_MVPå®æ–½è®¡åˆ’.md`
- ä»£ç ç¤ºä¾‹ â†’ æŸ¥çœ‹ä¿®æ­£åçš„æ–¹æ¡ˆæ–‡æ¡£

---

**å®¡æ ¸å®Œæˆæ—¶é—´**: 2026-02-21
**ä¸‹æ¬¡å¤å®¡**: é—®é¢˜ä¿®å¤å
**å®¡æ ¸äºº**: æŠ€æœ¯æ¶æ„å›¢é˜Ÿ
