# P3-2: 规则编辑器 UI 界面

**任务编号：** P3-2
**类型：** 前端 UI
**优先级：** P1
**负责人：** OpenCode
**预计时间：** 6 小时

---

## 📋 任务描述

实现可视化规则编辑器的 UI 界面，让用户可以直观地创建、编辑、删除和管理清理规则。

---

## 🎯 目标

### Part 1: 规则列表页面（2 小时）

**文件：** `src/ui/rule_editor_page.py`

**任务：**

1. 创建 RuleEditorPage 继承自 QWidget
2. 创建规则列表组件
   - 表格视图显示所有规则
   - 列：规则名称、类型、条件、动作、状态、优先级
   - 支持启用/禁用开关
   - 支持拖拽排序
3. 添加工具栏按钮
   - 新建规则
   - 导入规则
   - 导出规则
   - 刷新列表
   - 删除所选

**布局结构：**

```
┌─────────────────────────────────────────────┐
│ 规则编辑器                              [+导入] [导出] [刷新] │
├─────────────────────────────────────────────┤
│ 规则列表                                   │
│ ┌───┬────────┬────────┬──────┬──────┬─────┐ │
│ │[ ]│规则名称 │ 规则类型│ 条件│ 动作 │状态 │ │
│ ├───┼────────┼────────┼──────┼──────┼─────┤ │
│ │[✓]│临时文件 │ FILE_SIZE│>10MB│DELETE│启用 │ │
│ │[✓]│日志文件 │ DATE_MOD│ 7天 │DELETE│启用 │ │
│ │[ ]│下载文件 │ FILE_EXT│ .tmp│MOVE │禁用 │ │
│ └───┴────────┴────────┴──────┴──────┴─────┘ │
│ [新建规则] [编辑] [删除] [复制] [测试...]   │
└─────────────────────────────────────────────┘
```

**验收标准：**

- [ ] 规则列表正确显示所有规则
- [ ] 支持启用/禁用切换
- [ ] 支持拖拽排序
- [ ] 工具栏按钮功能正常

---

### Part 2: 规则编辑对话框（2 小时）

**文件：** `src/ui/rule_edit_dialog.py`

**任务：**

1. 创建 RuleEditDialog 继承自 QDialog
2. 分为多个标签页
   - ** 基本信息**
     - 规则名称（文本框）
     - 规则描述（文本框）
     - 规则类型（下拉菜单）
   - **条件设置**
     - 条件列表（表格）
     - 添加条件按钮
     - 条件逻辑（AND/OR）
   - **动作设置**
     - 动作类型（下拉菜单）
     - 动作参数（根据类型动态显示）
   - **预览和测试**
     - 测试文件选择
     - 预览匹配结果

**条件设置表单：**

```
条件设置
┌─────────────────────────────────────────┐
│ 条件逻辑: (○) AND  ( ) OR               │
│ ┌─────────────────────────────────────┐ │
│ │ 条件类型: [文件大小 ▼]              │ │
│ │ 操作符: [大于 ▼]                    │ │
│ │ 值: [10 MB]                         │ │
│ │ [删除] [上移] [下移]                │ │
│ └─────────────────────────────────────┘ │
│ [+ 添加条件]                            │
└─────────────────────────────────────────┘
```

**动作设置表单：**

```
动作设置
┌─────────────────────────────────────────┐
│ 动作类型: [删除 ▼]                      │
│                                         │
│ 根据 action type 显示不同参数:          │
│ • DELETE: 无参数                       │
│ • MOVE_TO: [目标路径: C:\Archives]     │
│ • ARCHIVE: [压缩格式: ZIP ▼]          │
│ • LOG_ONLY: [日志级别: INFO ▼]         │
└─────────────────────────────────────────┘
```

**验收标准：**

- [ ] 对话框能正常打开和关闭
- [ ] 基本信息、条件、动作都能正确设置
- [ ] 条件列表支持增删改和排序
- [ ] 验证输入数据有效性

---

### Part 3: 规则测试功能（1 小时）

**任务：**

1. 在 RuleEditDialog 中添加"预览和测试"标签页
2. 实现文件选择器
3. 实现规则匹配预览
   - 显示匹配的文件列表
   - 高亮显示匹配原因
   - 显示执行动作预期结果

**预览界面：**

```
预览和测试
┌─────────────────────────────────────────┐
│ 选择测试文件/文件夹: [...]               │
│                                         │
│ 测试结果:                               │
│ ┌─────────────────────────────────────┐ │
│ │ ✓ 匹配: C:\tmp\large_file.log       │ │
│ │   原因: 文件大小 12MB > 10MB         │ │
│ │   动作: 删除                         │ │
│ │                                     │ │
│ │ ✗ 不匹配: C:\Documents\doc.pdf      │ │
│ │   原因: 文件大小 2MB < 10MB         │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 匹配数: 1 / 2                           │
│ [应用到规则]  [重置]                     │
└─────────────────────────────────────────┘
```

**验收标准：**

- [ ] 能选择测试文件/文件夹
- [ ] 能正确显示匹配结果
- [ ] 高亮显示匹配原因
- [ ] 支持批量测试

---

### Part 4: 规则导入/导出（1 小时）

**任务：**

1. 实现规则导入功能
   - 支持 JSON 格式
   - 验证规则有效性
   - 避免重复规则（通过 ID 或名称检测）
   - 导入预览

2. 实现规则导出功能
   - 支持 JSON 格式
   - 导出规则选择（全部/选中）
   - 导出格式美观

3. 预置规则库界面
   - 显示可用预置规则
   - 一键应用预置规则

**导入对话框：**

```
导入规则
┌─────────────────────────────────────────┐
│ 选择文件: [...]                          │
│                                         │
│ 预览:                                   │
│ ┌─────────────────────────────────────┐ │
│ │ ☑ 临时文件清理规则                  │ │
│ │ ☑ 日志文件清理规则                  │ │
│ │ ☒ 下载文件清理规则 (已存在)          │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 合并策略: (○) 跳过已有规则 ( ) 覆盖   │
│                                         │
│ [导入] [取消]                           │
└─────────────────────────────────────────┘
```

**验收标准：**

- [ ] 规则导入成功且验证有效
- [ ] 规则导出格式正确
- [ ] 预置规则库可用
- [ ] 支持合并策略选择

---

## 📂 文件结构

```
purifyai/
├── src/
│   └── ui/
│       ├── rule_editor_page.py      # 规则列表页面
│       ├── rule_edit_dialog.py      # 规则编辑对话框
│       ├── components/
│       │   └── condition_widget.py   # 条件设置组件
│       └── resources/
│           └── icons/
│               ├── rule_add.png
│               ├── rule_edit.png
│               ├── rule_delete.png
│               └── rule_import.png
```

---

## 🔗 依赖关系

| 依赖任务 | 状态 |
|----------|------|
| P3-1: 规则编辑器后端 | 🔄 进行中 |
| Week 1-2 P0 任务 | ✅ 已完成 |

---

## 📝 备注

- UI 设计要简洁直观
- 支持快捷键（Ctrl+N 新建、Ctrl+E 编辑、Delete 删除）
- 支持撤销/重做操作
- 提供规则模板（常用规则）
- 样式要符合应用整体风格

---

## 🎯 成功指标

- ✅ 规则列表能正确显示和操作
- ✅ 规则编辑对话框能完整配置规则
- ✅ 规则测试功能准确预览匹配结果
- ✅ 规则导入/导出功能正常

---

**任务创建时间：** 2026-02-24 21:35
**预计完成时间：** 2026-02-25 03:35（6 小时后）
